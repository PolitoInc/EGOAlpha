{% extends 'Template_pk.html' %}
{% load bootstrap5 %}
{% load static %}
{% load type_filter %}

{% block title %}
	<span class="title">{{Customer.nameCustomer}}</span>   
{% endblock %}

{% block customer_records %}
<!-- Add this to your HTML file -->
<div id="popup" class="popup">
    <a href="#" class="close">&times;</a>
    <div id="popup-content"></div>
</div>
<div class="CustomerRecords">

    <div class="left">
    <!-- hidden until button clicked on display PK_Create -->
        <div class="PK_Create" id="popup-content">
            <form action="{% url 'CustomerPk' Customer.id %}" method="post">
                {% csrf_token %}
                <table>
                    {% for field in form %}
                        <tr>
                            <td>{{ field.label_tag }}</td>
                            <td class="field">{{ field }}</td>
                        </tr>
                    {% endfor %}
                </table>
                <input type="submit" value="OK">
            </form>
        </div>
        <!-- dUpdate Custome when clicked on PK_Create popupContent-->
        <button>Update Customer</button>
        <!-- data display -->

        {% for key, value in Customer.items %}
            {% if key != "customerrecords" and key != "whois_customers" and key != "domainScope" and key != 'unique_geocodes'%}
                <div class="bulk_values"><strong>{{ key }}</strong>: {{ value }}</div>
            {% elif key == "unique_geocodes" %}
            <b>{{key}}: </b>

            <table id="sorttable">
                <thead>
                    <tr>
            <th>country</th>
            <th>ip address</th>
            <th >city</th>
                    </tr>
                </thead>
                <tbody>
                    {% for val in value %}
                        <tr>
                            <td>{{ val|get_item:'country' }}</td>
                            <td>{{ val|get_item:'ip_address' }}</td>
                            <td>{{ val|get_item:'city' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
           
            {% elif key == "customerrecords" %}
                <div>
                    <div><strong>{{ key }}</strong>:</div>
                    <form method="GET" action="">
                        <input type="text" name="search" placeholder="Search">
                        <input type="submit" value="Search">
                    </form>
                    <ul class="pagination">
                        {% if page_obj.has_previous %}
                            <li><a href="?page={{ page_obj.previous_page_number }}">previous</a></li>
                        {% endif %}
                        <li class="current">{{ page_obj.number }}</li>
                        {% if page_obj.has_next %}
                            <li><a href="?page={{ page_obj.next_page_number }}">next</a></li>
                        {% endif %}
                    </ul>
                    {% for sub_value in value %}
                        <div class="records" onclick="showPopup(this)">
                            {% for sub_keys, sub_values in sub_value.items %}
                            <table>
                                {% if sub_keys == "" %}
                                    <tr class="div_titles" >{{sub_keys}}
                                        {% for Nested_dicts in sub_values %}
                                            {% for sub_key in Nested_dicts %}
                                                <p class="no-padding name">{{ sub_key }}: </p>
                                            {% endfor %}
                                        {% endfor %}
                                    </tr>
                                <!-- retrieving subs with nested values -->   
                                {% elif sub_keys == "GEOCODES" or sub_keys == "RecRequestMetaData" or sub_keys == "Certificates_record" or sub_keys == "Nmaps_record" or sub_keys == "Templates_record" or sub_keys == "DNSQuery_record" or sub_keys == "DNSAuthority_record"%}
                                    <tr class="div_titles_nested">
{{sub_keys}}: 
                                        {% for nes in sub_values %}
                                        {% for nes_key, nes_val in nes.items %}
                                        <p class="no-padding">{{ nes_key }}: {{nes_val}}</p>
                                        {% endfor %}
                                         {% endfor %}
                                    </tr>
                                {% elif sub_keys == "md5" or sub_keys == "customer_id" or sub_keys == "id" or sub_keys == "foundVuln_record" %}

                                <!-- retrieving subs with nested None tpes -->
                                {% elif sub_values == None or sub_values.0 == None%}
                                {% elif  sub_keys == "subDomain" %}
                                    <tr class="div_titles_subDomain"><p class="subDomain_title">{{sub_values}}</p></tr>
                                {% elif sub_keys == "domainname"%}
                                    <tr class="div_titles_domainname"><p class="domain_title">{{sub_values}}</p></tr>
                                {% else %}
                                    <tr class="div_titles"><p class="no-padding">{{ sub_keys }}: {{sub_values}}</p></tr>
                                {% endif %}
                                </table>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        {% endfor %}
    </div>
    <div class="right">
        <!-- data display -->
        <div class="data_display">
        {% for key, value in Customer.items %}
            {% if key == "whois_customers" %}
                
                <div class="sub_list_whois">
                    <div><strong>{{ key }}</strong>:</div>
                    <table class="whois_table">
                    {% for sub_value in value %}
                        <tr class="tr_whois" >
                        <td>

                            {% for sub_key, sub_values in sub_value.items %}
                                {% if sub_key == "state" %}
                                {% elif sub_key == "map_image" %}
                                    <p class="no_padding_name">{{ sub_key }}</p>
                                        {% with new_x=sub_values|slice:"6:" %}
                                            <iframe src="{{ new_x }}"></iframe>
                                        {% endwith %}
                                
                                {% elif sub_key != "id" and sub_key != "customer_id" and sub_values != "None" and sub_values != None %}
                                    <p class="no_padding_name">{{ sub_key }}: <span class="sub_values">{{ sub_values }}</span></p>
                                {%  else %}
                                {% endif %}
                            {% endfor %}

                            </td>
                            </tr>
                    {% endfor %}
                    </table>
                </div>
                
            {% elif key == "domainScope" %}
                <div class="sub_list_domainScope">

                        <tr class="div_titles" >
                            <td><strong>{{ key }}</strong></td>
                            <td>
                                {% for x in value %}
        {% with new_x=x|slice:"2:" %}
            <p class="no-padding name"><a href="?search={{ new_x }}">{{x}}</a></p>
        {% endwith %}
                                {% endfor %}
                            </td>
                        </tr>
                    
                </div>
            {% endif %}
        {% endfor %}
        </div>
    </div>

</div>
<!-- javascript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var updateButton = document.querySelector('button');
        var pkCreate = document.querySelector('.PK_Create');

        updateButton.addEventListener('click', function() {
            if (pkCreate.style.display === 'none' || pkCreate.style.display === '') {
                pkCreate.style.display = 'block';
            } else {
                pkCreate.style.display = 'none';
            }
        });
    });
</script>


    <script>
        function showPopup(element) {
            var popup = document.getElementById('popup');
            var popupContent = document.getElementById('popup-content');
            popupContent.innerHTML = element.innerHTML;
            window.location.hash = 'popup';
        }

        document.querySelector('.close').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.hash = '';
        });
    </script>

        <script>
        function stripSpecialChars(query) {
            return query.replace(/\*/g, '').replace(/\./g, '');
        }

        function handleSearch(event) {
            event.preventDefault();
            var query = document.getElementById('searchInput').value;
            var strippedQuery = stripSpecialChars(query);
            window.location.href = "?search=" + strippedQuery;
        }
    </script>


{% endblock %}

{% block description %}
    <div class="left">
        <!-- data display -->
        {% for key, value in Customer.items %}

        {% endfor %}
    </div>
{% endblock %}
